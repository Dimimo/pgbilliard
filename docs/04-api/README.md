# API Documentation

This section provides comprehensive documentation for the Puerto Galera Billiard League API.

## Overview

The application provides a minimal REST API for specific integrations. The primary interface is the web application built with Livewire, but API endpoints are available for:

- Mobile app integration
- Third-party integrations
- Webhooks
- External data access

## API Version

Current API Version: **v1**

Base URL: `https://www.pgbilliard.com/api/v1`

## Authentication

The API uses Laravel Sanctum for token-based authentication.

### Obtaining an API Token

```http
POST /api/v1/auth/login
Content-Type: application/json

{
    "email": "user@example.com",
    "password": "password"
}
```

Response:

```json
{
    "token": "1|abc123def456...",
    "user": {
        "id": 1,
        "name": "John Doe",
        "email": "user@example.com"
    }
}
```

### Using the Token

Include the token in the Authorization header:

```http
GET /api/v1/teams
Authorization: Bearer 1|abc123def456...
```

## Rate Limiting

API requests are rate-limited to:

- **Authenticated users**: 60 requests per minute
- **Unauthenticated users**: 10 requests per minute

Rate limit headers are included in responses:

```text
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 59
X-RateLimit-Reset: 1640000000
```

## Response Format

### Success Response

```json
{
    "data": {
        "id": 1,
        "name": "Team Name",
        "captain": "John Doe"
    },
    "message": "Success"
}
```

### Error Response

```json
{
    "error": "Resource not found",
    "message": "The requested team does not exist",
    "code": 404
}
```

### Pagination

Paginated responses include metadata:

```json
{
    "data": [...],
    "links": {
        "first": "https://api.example.com/teams?page=1",
        "last": "https://api.example.com/teams?page=10",
        "prev": null,
        "next": "https://api.example.com/teams?page=2"
    },
    "meta": {
        "current_page": 1,
        "from": 1,
        "last_page": 10,
        "per_page": 15,
        "to": 15,
        "total": 150
    }
}
```

## API Endpoints

### Authentication

- `POST /api/v1/auth/login` - Login and obtain token
- `POST /api/v1/auth/logout` - Logout and revoke token
- `POST /api/v1/auth/register` - Register new user
- `GET /api/v1/auth/user` - Get authenticated user

### Teams

- `GET /api/v1/teams` - List all teams
- `GET /api/v1/teams/{id}` - Get team details
- `POST /api/v1/teams` - Create new team (requires auth)
- `PUT /api/v1/teams/{id}` - Update team (requires auth)
- `DELETE /api/v1/teams/{id}` - Delete team (requires auth)
- `GET /api/v1/teams/{id}/players` - Get team players
- `GET /api/v1/teams/{id}/games` - Get team games
- `GET /api/v1/teams/{id}/ranking` - Get team ranking

### Players

- `GET /api/v1/players` - List all players
- `GET /api/v1/players/{id}` - Get player details
- `GET /api/v1/players/{id}/stats` - Get player statistics
- `GET /api/v1/players/{id}/games` - Get player games

### Games

- `GET /api/v1/games` - List all games
- `GET /api/v1/games/{id}` - Get game details
- `POST /api/v1/games` - Create new game (requires auth)
- `PUT /api/v1/games/{id}` - Update game score (requires auth)
- `GET /api/v1/games/upcoming` - Get upcoming games
- `GET /api/v1/games/recent` - Get recent games

### Schedules

- `GET /api/v1/schedules` - List all schedules
- `GET /api/v1/schedules/{id}` - Get schedule details
- `GET /api/v1/schedules/date/{date}` - Get schedules for specific date

### Rankings

- `GET /api/v1/rankings` - Get current team rankings
- `GET /api/v1/rankings/season/{id}` - Get rankings for specific season

### Seasons

- `GET /api/v1/seasons` - List all seasons
- `GET /api/v1/seasons/{id}` - Get season details
- `GET /api/v1/seasons/current` - Get current active season

## Detailed Endpoint Documentation

For detailed endpoint documentation including:

- Request parameters
- Response schemas
- Example requests and responses
- Error codes

Visit the interactive API documentation generated by Scribe:

**API Documentation**: `https://www.pgbilliard.com/docs`

## WebSocket Events

The application uses Laravel Reverb for real-time features. Connect to the WebSocket server to receive real-time updates.

### Connection

```javascript
import Echo from 'laravel-echo';
import Pusher from 'pusher-js';

window.Pusher = Pusher;

window.Echo = new Echo({
    broadcaster: 'reverb',
    key: process.env.REVERB_APP_KEY,
    wsHost: process.env.REVERB_HOST,
    wsPort: process.env.REVERB_PORT,
    forceTLS: process.env.REVERB_SCHEME === 'https',
});
```

### Available Channels

#### Public Channels

- `games` - Game updates
- `rankings` - Ranking updates
- `schedules` - Schedule changes

#### Private Channels

- `teams.{id}` - Team-specific updates
- `users.{id}` - User-specific notifications

### Event Examples

#### Game Score Updated

```javascript
Echo.channel('games')
    .listen('ScoreUpdated', (e) => {
        console.log('Game score updated:', e.game);
    });
```

#### Team Ranking Changed

```javascript
Echo.channel('rankings')
    .listen('RankingUpdated', (e) => {
        console.log('Rankings updated:', e.rankings);
    });
```

#### Private Team Updates

```javascript
Echo.private(`teams.${teamId}`)
    .listen('TeamUpdated', (e) => {
        console.log('Team updated:', e.team);
    });
```

## Webhooks

The application can send webhooks for specific events.

### Configuring Webhooks

Webhooks are configured in the admin panel or via API:

```http
POST /api/v1/webhooks
Authorization: Bearer {token}
Content-Type: application/json

{
    "url": "https://example.com/webhook",
    "events": ["game.completed", "team.created"],
    "secret": "your-webhook-secret"
}
```

### Webhook Events

- `game.completed` - Fired when a game is marked complete
- `game.started` - Fired when a game starts
- `team.created` - Fired when a new team is created
- `team.updated` - Fired when a team is updated
- `ranking.updated` - Fired when rankings change

### Webhook Payload

```json
{
    "event": "game.completed",
    "timestamp": "2024-01-15T10:30:00Z",
    "data": {
        "game_id": 123,
        "team_home": "Team A",
        "team_away": "Team B",
        "score_home": 15,
        "score_away": 12,
        "winner": "Team A"
    },
    "signature": "sha256=..."
}
```

### Verifying Webhook Signatures

```php
$payload = file_get_contents('php://input');
$signature = hash_hmac('sha256', $payload, $webhookSecret);
$expected = $_SERVER['HTTP_X_SIGNATURE'];

if (!hash_equals($signature, $expected)) {
    abort(403, 'Invalid signature');
}
```

## Error Codes

| Code | Description |
| ---- | ----------- |
| 200 | Success |
| 201 | Created |
| 204 | No Content |
| 400 | Bad Request |
| 401 | Unauthorized |
| 403 | Forbidden |
| 404 | Not Found |
| 422 | Validation Error |
| 429 | Too Many Requests |
| 500 | Internal Server Error |
| 503 | Service Unavailable |

## Best Practices

### Caching

Cache responses when appropriate:

```http
GET /api/v1/rankings
Cache-Control: public, max-age=300
```

### Conditional Requests

Use ETags for conditional requests:

```http
GET /api/v1/teams/1
If-None-Match: "abc123"

Response:
304 Not Modified
```

### Batch Requests

For multiple related requests, consider using batch endpoints (if available) or GraphQL.

### Error Handling

Always handle errors gracefully:

```javascript
try {
    const response = await fetch('/api/v1/teams');
    const data = await response.json();
} catch (error) {
    console.error('API Error:', error);
}
```

## SDKs and Client Libraries

### JavaScript/TypeScript

```bash
npm install @pgbilliard/api-client
```

```javascript
import { PGBilliardClient } from '@pgbilliard/api-client';

const client = new PGBilliardClient({
    token: 'your-api-token'
});

const teams = await client.teams.list();
```

### PHP

```bash
composer require pgbilliard/php-client
```

```php
use PGBilliard\Client;

$client = new Client('your-api-token');
$teams = $client->teams()->list();
```

## Resources

- [Laravel Sanctum Documentation](https://laravel.com/docs/sanctum)
- [Laravel Broadcasting](https://laravel.com/docs/broadcasting)
- [Laravel Reverb](https://laravel.com/docs/reverb)
- [Scribe Documentation Generator](https://scribe.knuckles.wtf/)

## Support

For API support:

- Email: [api@pgbilliard.com](mailto:api@pgbilliard.com)
- Issues: [GitHub Issues](https://github.com/yourrepo/issues)
